# AI Chat API Documentation

## Overview

The AI Chat API enables multi-turn conversations with full context management. Each conversation maintains message history, and responses are generated by the Groq LLM considering all previous messages in the conversation.

## Setup

Ensure `GROQ_API_KEY` is set in `.env`:
```env
GROQ_API_KEY=your_groq_api_key_here
```

Get a free API key: https://console.groq.com

## Endpoints

### 1. POST `/api/ai-chat/message` - Send Message

**Description:** Send a message in a conversation. Creates a new conversation if `conversationId` is not provided.

**Request:**
```json
{
  "message": "Explain photosynthesis",
  "conversationId": 1,
  "systemPrompt": "Optional custom system prompt"
}
```

**Parameters:**
- `message` (required): The user's message
- `conversationId` (optional): Existing conversation ID. If omitted, creates new conversation
- `systemPrompt` (optional): Custom system prompt (overrides default tutor prompt)

**Response (Success - 201):**
```json
{
  "success": true,
  "data": {
    "conversationId": 1,
    "messageId": 42,
    "message": "Photosynthesis is the process by which plants convert light energy into chemical energy...",
    "isNewConversation": false,
    "timestamp": "2025-11-15T12:30:45.123Z"
  }
}
```

**Response (Error - 400):**
```json
{
  "success": false,
  "error": "message is required and must be a non-empty string"
}
```

**cURL Example:**
```bash
# New conversation
curl -X POST http://localhost:3000/api/ai-chat/message \
  -H "Content-Type: application/json" \
  -d '{
    "message": "What is photosynthesis?"
  }'

# Continue existing conversation
curl -X POST http://localhost:3000/api/ai-chat/message \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Tell me more about chlorophyll",
    "conversationId": 1
  }'
```

**PowerShell Example:**
```powershell
$body = @{
    message = "What is photosynthesis?"
} | ConvertTo-Json

Invoke-WebRequest -Uri "http://localhost:3000/api/ai-chat/message" `
  -Method POST `
  -ContentType "application/json" `
  -Body $body
```

---

### 2. GET `/api/ai-chat/:conversationId` - Get Full Conversation

**Description:** Retrieve complete conversation with all messages.

**Parameters:**
- `conversationId` (path, required): ID of the conversation

**Response (Success - 200):**
```json
{
  "success": true,
  "data": {
    "conversation": {
      "id": 1,
      "title": "Understanding photosynthesis",
      "messageCount": 4,
      "createdAt": "2025-11-15T12:00:00Z",
      "updatedAt": "2025-11-15T12:30:45Z"
    },
    "messages": [
      {
        "id": 1,
        "sequenceNumber": 1,
        "role": "user",
        "content": "What is photosynthesis?",
        "createdAt": "2025-11-15T12:00:00Z"
      },
      {
        "id": 2,
        "sequenceNumber": 2,
        "role": "assistant",
        "content": "Photosynthesis is the process...",
        "createdAt": "2025-11-15T12:00:05Z"
      }
    ]
  }
}
```

**cURL Example:**
```bash
curl http://localhost:3000/api/ai-chat/1
```

---

### 3. GET `/api/ai-chat/:conversationId/history?limit=20` - Get Recent Messages

**Description:** Fetch last N messages from a conversation (for pagination).

**Parameters:**
- `conversationId` (path, required): ID of the conversation
- `limit` (query, optional): Max number of messages to return (default: 20, max: 100)

**Response (Success - 200):**
```json
{
  "success": true,
  "data": {
    "conversationId": 1,
    "messageCount": 3,
    "messages": [
      {
        "id": 2,
        "role": "assistant",
        "content": "Photosynthesis is...",
        "createdAt": "2025-11-15T12:00:05Z"
      },
      {
        "id": 3,
        "role": "user",
        "content": "Tell me more about chlorophyll",
        "createdAt": "2025-11-15T12:10:00Z"
      },
      {
        "id": 4,
        "role": "assistant",
        "content": "Chlorophyll is...",
        "createdAt": "2025-11-15T12:10:05Z"
      }
    ]
  }
}
```

**cURL Example:**
```bash
curl "http://localhost:3000/api/ai-chat/1/history?limit=20"
```

---

### 4. GET `/api/ai-chat/:conversationId/metadata` - Get Conversation Metadata

**Description:** Get conversation details without fetching messages.

**Response (Success - 200):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "title": "Understanding photosynthesis",
    "messageCount": 4,
    "createdAt": "2025-11-15T12:00:00Z",
    "updatedAt": "2025-11-15T12:30:45Z"
  }
}
```

---

### 5. GET `/api/ai-chat/conversations/list?limit=20&offset=0` - List All Conversations

**Description:** Get paginated list of all conversations.

**Parameters:**
- `limit` (query, optional): Conversations per page (default: 20, max: 100)
- `offset` (query, optional): Number of conversations to skip (default: 0)

**Response (Success - 200):**
```json
{
  "success": true,
  "data": {
    "total": 15,
    "limit": 20,
    "offset": 0,
    "conversations": [
      {
        "id": 1,
        "title": "Understanding photosynthesis",
        "messageCount": 4,
        "createdAt": "2025-11-15T12:00:00Z",
        "updatedAt": "2025-11-15T12:30:45Z"
      },
      {
        "id": 2,
        "title": "Cellular respiration explained",
        "messageCount": 2,
        "createdAt": "2025-11-14T15:20:00Z",
        "updatedAt": "2025-11-14T15:25:00Z"
      }
    ]
  }
}
```

**cURL Example:**
```bash
curl "http://localhost:3000/api/ai-chat/conversations/list?limit=10&offset=0"
```

---

### 6. POST `/api/ai-chat/new` - Create New Conversation

**Description:** Create a new empty conversation without sending a message.

**Request:**
```json
{
  "title": "Optional custom title"
}
```

**Response (Success - 201):**
```json
{
  "success": true,
  "data": {
    "conversationId": 5,
    "title": "Optional custom title",
    "messageCount": 0,
    "createdAt": "2025-11-15T13:00:00Z"
  }
}
```

---

### 7. DELETE `/api/ai-chat/:conversationId` - Delete Conversation

**Description:** Delete a conversation and all its messages.

**Response (Success - 200):**
```json
{
  "success": true,
  "message": "Conversation 1 deleted successfully"
}
```

**cURL Example:**
```bash
curl -X DELETE http://localhost:3000/api/ai-chat/1
```

---

## Message Flow Diagram

```
User sends message (POST /api/ai-chat/message)
       ↓
[Validate message content]
       ↓
Create NEW conversation?
       ├─ YES → Generate title from first message
       └─ NO → Use existing conversationId
       ↓
[Fetch previous messages from DB]
       ↓
[Build LLM message history]
  - All previous user/assistant messages
  - Current user message
  - System prompt
       ↓
[Call Groq LLM with full context]
       ↓
[Receive AI response]
       ↓
[Save user message to DB]
       ↓
[Save assistant response to DB]
       ↓
[Update conversation timestamp]
       ↓
[Return response to client]
```

## Database Schema

### ai_conversations table
```sql
CREATE TABLE ai_conversations (
  id SERIAL PRIMARY KEY,
  title VARCHAR(500) NOT NULL DEFAULT 'New Conversation',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ai_chat_messages table
```sql
CREATE TABLE ai_chat_messages (
  id SERIAL PRIMARY KEY,
  conversation_id INTEGER NOT NULL REFERENCES ai_conversations(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Context Management

The AI maintains context by:

1. **Message History:** All previous messages in conversation are fetched (max 20 messages for performance)
2. **Chronological Order:** Messages are sent to LLM in creation order
3. **System Prompt:** Always included to set tutor behavior
4. **Token Limit:** Response max 2048 tokens to prevent excessive content

## Integration Examples

### React Chat Component
```typescript
import { useState } from 'react';

function ChatInterface() {
  const [conversationId, setConversationId] = useState<number | null>(null);
  const [messages, setMessages] = useState<Array<{ role: string; content: string }>>([]);
  const [loading, setLoading] = useState(false);

  const sendMessage = async (message: string) => {
    setLoading(true);
    try {
      const res = await fetch('/api/ai-chat/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message,
          conversationId: conversationId || undefined
        })
      });

      const data = await res.json();
      if (data.success) {
        setConversationId(data.data.conversationId);
        setMessages([
          ...messages,
          { role: 'user', content: message },
          { role: 'assistant', content: data.data.message }
        ]);
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      {messages.map((msg, i) => (
        <div key={i} className={msg.role}>
          <p>{msg.content}</p>
        </div>
      ))}
      <input 
        placeholder="Type your question..."
        onKeyPress={(e) => {
          if (e.key === 'Enter' && e.currentTarget.value) {
            sendMessage(e.currentTarget.value);
            e.currentTarget.value = '';
          }
        }}
        disabled={loading}
      />
    </div>
  );
}
```

### Node.js/Fetch
```typescript
async function chatWithAI(message: string, conversationId?: number) {
  const response = await fetch('http://localhost:3000/api/ai-chat/message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      message,
      conversationId
    })
  });

  const result = await response.json();
  if (result.success) {
    const { conversationId: convId, message: aiResponse, isNewConversation } = result.data;
    
    if (isNewConversation) {
      console.log(`Started new conversation: ${convId}`);
    }
    
    console.log('AI:', aiResponse);
    return convId;
  } else {
    throw new Error(result.error);
  }
}
```

## Error Handling

| HTTP Status | Error | Cause | Solution |
|-------------|-------|-------|----------|
| 400 | `message is required...` | Missing/empty message | Provide valid message text |
| 400 | `conversationId must be a number` | Invalid conversation ID | Use numeric ID or omit for new |
| 404 | `Conversation X not found` | Conversation doesn't exist | Check conversation ID |
| 500 | `LLM failed: ...` | Groq API error | Check GROQ_API_KEY, rate limits |
| 500 | `Unknown error occurred` | Database error | Check database connection |

## Performance Tips

- **Context Window:** System loads last 20 messages for context (configurable)
- **Response Time:** 0.5-2 seconds per message
- **Conversation Size:** No practical limit (indexed by conversation_id)
- **Rate Limits:** Depends on Groq API (free tier: ~30 requests/minute)

## System Prompt

Default tutor prompt:
```
You are an expert AI tutor assistant helping students learn. Your responsibilities:
- Provide clear, accurate, and comprehensive explanations
- Break down complex concepts into simpler parts
- Answer questions directly and thoroughly
- Use examples and analogies when helpful
- Encourage deeper understanding through follow-up suggestions
- Be patient, supportive, and encouraging
- Maintain context from previous messages in this conversation
- Adapt your explanations to the student's apparent level of understanding
```

Custom prompts can be provided per message to override this.

## Testing the API

### Step 1: Start New Conversation
```bash
curl -X POST http://localhost:3000/api/ai-chat/message \
  -H "Content-Type: application/json" \
  -d '{"message": "What is machine learning?"}'
```

Save the `conversationId` from response.

### Step 2: Continue Conversation
```bash
curl -X POST http://localhost:3000/api/ai-chat/message \
  -H "Content-Type: application/json" \
  -d '{"message": "Can you give me an example?", "conversationId": 1}'
```

### Step 3: View Full Conversation
```bash
curl http://localhost:3000/api/ai-chat/1
```

### Step 4: List All Conversations
```bash
curl http://localhost:3000/api/ai-chat/conversations/list
```

### Step 5: Delete Conversation
```bash
curl -X DELETE http://localhost:3000/api/ai-chat/1
```

## Next Steps

1. Send your first message via `/api/ai-chat/message`
2. Receive `conversationId` in response
3. Use that ID for subsequent messages in same conversation
4. AI automatically maintains context from all previous messages
5. Retrieve full conversation anytime via GET endpoint
